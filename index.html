<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Late Shift Dashboard</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text:#e8eef7;
      --muted:#9fb2c7;
      --blue:#00b7ff;
      --blue2:#2ee7ff;
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(0,183,255,.20), transparent 55%),
        radial-gradient(700px 450px at 85% 20%, rgba(46,231,255,.14), transparent 55%),
        radial-gradient(800px 550px at 50% 85%, rgba(0,183,255,.10), transparent 60%),
        linear-gradient(180deg, #0a0d12 0%, #070a0f 100%);
      min-height:100vh;
      padding:24px;
    }

    .wrap{
      width:min(1200px, 100%);
      margin:0 auto;
      display:grid;
      gap:16px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding:6px 4px;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size:28px; letter-spacing:.2px; line-height:1.1; }
    .subtitle{ margin:0; color:var(--muted); font-size:14px; }

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      color:var(--muted);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
      white-space:nowrap;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .pill .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(90deg, var(--blue), var(--blue2));
      box-shadow: 0 0 0 3px rgba(0,183,255,.12);
      flex:0 0 auto;
    }

    /* ===== TWO PANEL LAYOUT ===== */
    .main-grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:start;
    }

    @media (max-width: 950px){
      .main-grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .panel-inner{ padding:18px; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      border-top:1px solid var(--stroke);
      padding:14px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    button:hover{ border-color: rgba(0,183,255,.45); background: rgba(0,183,255,.10); }
    button:active{ transform: scale(.98); }
    .danger:hover{ border-color: rgba(255,80,80,.5); background: rgba(255,80,80,.10); }

    .progress{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      user-select:none;
    }

    .bar{
      width:170px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      overflow:hidden;
    }
    .bar > span{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--blue), var(--blue2));
      border-radius:999px;
      transition: width .2s ease;
    }

    /* Checklist */
    .task-list{ display:grid; gap:10px; }

    .section{
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(0,183,255,.22);
      background: rgba(0,183,255,.06);
      color: var(--text);
      font-weight:800;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .section small{
      color: var(--muted);
      font-weight:600;
      letter-spacing:0;
    }

    .task{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:14px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(255,255,255,.04);
      transition: border-color .15s ease, background .15s ease;
    }
    .task:hover{
      border-color: rgba(0,183,255,.35);
      background: rgba(255,255,255,.055);
    }
    .task input[type="checkbox"]{
      margin-top:2px;
      width:18px; height:18px;
      accent-color: var(--blue);
      cursor:pointer;
      flex:0 0 auto;
    }
    .task .text{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .task .name{ font-weight:800; font-size:14px; letter-spacing:.2px; }
    .task .desc{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; white-space:pre-wrap; }

    .task.done{ opacity:.78; border-color: rgba(0,183,255,.25); }
    .task.done .name{
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      text-decoration-color: rgba(0,183,255,.65);
    }

    .footer-note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }

    /* Right panel cards */
    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:14px;
    }
    .card + .card{ margin-top:12px; }

    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .hint{
      margin: -6px 0 10px 0;
      color: var(--muted);
      font-size: 12px;
    }

    .row{ display:grid; gap:10px; }
    .row.two{ grid-template-columns: 1fr 1fr; }

    input, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,12,16,.35);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 13px;
    }
    input:focus, textarea:focus{
      border-color: rgba(0,183,255,.55);
      box-shadow: 0 0 0 3px rgba(0,183,255,.10);
    }

    textarea{
      min-height: 140px;
      resize: vertical;
      line-height: 1.4;
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    @media (max-width:720px){
      .row.two{ grid-template-columns: 1fr; }
    }
    @media (max-width:520px){
      .bar{ width:120px; }
      h1{ font-size:24px; }
    }

    /* ===== Quick links icons ===== */
    .icon-sub{
      font-size:12px;
      color: var(--muted);
      font-weight:600;
      margin-left:auto;
      white-space:nowrap;
    }

    .quick-links{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .icon-btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      text-decoration:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      flex: 1 1 140px;
      justify-content:flex-start;
    }
    .icon-btn:hover{
      border-color: rgba(0,183,255,.45);
      background: rgba(0,183,255,.10);
    }
    .icon-btn:active{ transform: scale(.98); }

    .icon{
      width:22px;
      height:22px;
      display:inline-block;
      flex:0 0 auto;
    }
    .icon-label{
      font-size:13px;
      font-weight:800;
      letter-spacing:.2px;
      color: var(--text);
    }

    /* Simple electric-blue Google badge */
    .g-badge{
      width:22px;
      height:22px;
      border-radius:8px;
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      color:#061018;
      background: linear-gradient(90deg, var(--blue), var(--blue2));
      box-shadow: 0 0 0 3px rgba(0,183,255,.12);
    }

    /* Motivational quote */
    .quote-box{
      border: 1px solid rgba(0,183,255,.25);
      background: rgba(0,183,255,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .quote{
      margin:0;
      font-size:14px;
      line-height:1.4;
      font-weight:800;
      letter-spacing:.2px;
    }
    .quote-by{
      margin:8px 0 0 0;
      color: var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .quote-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
      justify-content:space-between;
    }
    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
      color: var(--muted);
      font-size:12px;
      user-select:none;
    }
    .toggle input{ width:16px; height:16px; accent-color: var(--blue); }
    .tiny-btn{
      padding:9px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:13px;
    }

    /* ===== Duty Search ===== */
    #dutyResults{ display:grid; gap:10px; }
    .result{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .result:hover{
      border-color: rgba(0,183,255,.35);
      background: rgba(255,255,255,.055);
    }
    .result-left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .result-title{ font-weight:900; letter-spacing:.2px; }
    .result-sub{
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .result-btn{
      flex:0 0 auto;
      padding:9px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:13px;
    }

    /* ===== Modal ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:999;
    }
    .modal.show{ display:block; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .modal-panel{
      position:relative;
      width:min(900px, calc(100% - 28px));
      margin: 20px auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-title{ font-weight:900; letter-spacing:.2px; }
    .modal-sub{ color: var(--muted); font-size: 12px; margin-top: 4px; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .modal-body{ padding:16px; max-height: calc(100vh - 140px); overflow:auto; }
    .duty-pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      color: var(--text);
      line-height: 1.45;
    }
    .duty-kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .kv{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      color: var(--muted);
    }
    .kv strong{ color: var(--text); font-weight:900; }
    @media (max-width: 700px){
      .duty-kv{ grid-template-columns: 1fr; }
    }
  
    /* Duty timetable table */
    .duty-table{
      display:grid;
      gap:8px;
      margin-bottom:12px;
    }
    .duty-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .duty-dest{
      font-weight:900;
      letter-spacing:.2px;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .duty-time{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      color: var(--text);
      flex:0 0 auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,183,255,.25);
      background: rgba(0,183,255,.06);
    }
    .raw-toggle{
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      text-decoration: underline;
      text-decoration-color: rgba(0,183,255,.55);
      text-underline-offset: 3px;
    }

  
    /* Duty split lists (all times + all destinations) */
    .duty-split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    .split-card{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .split-title{
      font-weight:900;
      letter-spacing:.2px;
      margin:0 0 10px 0;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .split-count{
      color: var(--muted);
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }
    .split-list{
      display:grid;
      gap:8px;
      max-height: 260px;
      overflow:auto;
      padding-right:4px;
    }
    .split-item{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:9px 10px;
      font-size:12.5px;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .split-item .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      flex:0 0 auto;
    }
    .split-item .dest{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-weight:800;
    }
    @media (max-width: 760px){
      .duty-split{ grid-template-columns: 1fr; }
      .split-list{ max-height: 220px; }
    }
  
    /* ===== Duty board renderer ===== */
    .board-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .board-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 680px){
      .board-grid{ grid-template-columns: 1fr; }
    }
    .board-card{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .board-head{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .board-title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .board-sub{
      color: var(--muted);
      font-size:12px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .board-rows{ display:grid; gap:8px; }
    .board-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      min-width:0;
    }
    .board-dest{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .board-time{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      flex:0 0 auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,183,255,.25);
      background: rgba(0,183,255,.06);
    }
    .board-note{
      color: var(--muted);
      font-size:12px;
      margin-top:8px;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Late Shift</h1>
        <p class="subtitle">Tick tasks off — saves automatically. Clear for next day when finished.</p>
      </div>

      <div class="meta">
        <div class="pill" id="todayPill"><span class="dot"></span><span>Today</span></div>
        <div class="pill" id="timePill"><span class="dot"></span><span>--:--:--</span></div>
        <div class="pill" id="weatherPill"><span class="dot"></span><span>Birkenhead weather…</span></div>
      </div>
    </header>

    <div class="main-grid">
      <!-- LEFT: CHECKLIST -->
      <section class="panel">
        <div class="panel-inner">
          <div class="task-list" id="taskList"></div>

          <div class="footer-note">
            <strong>REMEMBER:</strong> If you’re not sure… ask. If you make a mistake… admit it.
          </div>
        </div>

        <div class="controls">
          <div class="progress">
            <span id="progressText">0/0 done</span>
            <div class="bar" aria-hidden="true"><span id="progressBar"></span></div>
          </div>

          <div class="btns">
            <button id="markAllBtn" type="button">Mark all</button>
            <button id="clearBtn" type="button" class="danger">Clear for next day</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: OTHER BITS -->
      <section class="panel">
        <div class="panel-inner">

          <!-- Quick Links -->
          <div class="card">
            <h2>Quick Links <span class="icon-sub">opens in a new tab</span></h2>
            <div class="hint">Outlook · OneDrive · Google</div>

            <div class="quick-links">
              <a class="icon-btn" href="https://outlook.office.com/mail/" target="_blank" rel="noopener noreferrer" title="Open Outlook">
                <!-- Outlook icon (inline SVG) -->
                <svg class="icon" viewBox="0 0 64 64" aria-hidden="true">
                  <path fill="#1a6be3" d="M36 10h18c2.2 0 4 1.8 4 4v36c0 2.2-1.8 4-4 4H36V10z"/>
                  <path fill="#0f4bb8" d="M36 18h22v28H36V18z"/>
                  <path fill="#2b88ff" d="M6 16l28-6v44L6 48V16z"/>
                  <path fill="#fff" d="M20.2 26.2c4.2 0 7.6 3.4 7.6 9.8s-3.4 9.8-7.6 9.8-7.6-3.4-7.6-9.8 3.4-9.8 7.6-9.8zm0 4.2c-1.8 0-3.3 1.6-3.3 5.6s1.5 5.6 3.3 5.6 3.3-1.6 3.3-5.6-1.5-5.6-3.3-5.6z"/>
                  <path fill="#1458cf" d="M36 22l22 14-22 14V22z"/>
                </svg>
                <span class="icon-label">Outlook</span>
              </a>

              <a class="icon-btn" href="https://onedrive.live.com/" target="_blank" rel="noopener noreferrer" title="Open OneDrive">
                <!-- OneDrive icon (inline SVG) -->
                <svg class="icon" viewBox="0 0 64 64" aria-hidden="true">
                  <path fill="#1a6be3" d="M29 22c3-5 8-8 14-8 9 0 16 7 16 16 0 1-.1 2-.3 3 3.3 1.4 5.3 4.2 5.3 7.5 0 4.8-4 8.5-9 8.5H23c-7.2 0-13-5.8-13-13 0-6.6 4.9-12.1 11.3-12.9C23 20.8 26 20.4 29 22z"/>
                  <path fill="#2b88ff" d="M22.5 28.5c2.6-5.2 7.5-8.5 13.4-8.5 6.6 0 12.4 4.2 14.5 10.3-1.3-.4-2.6-.6-4-.6H26c-1.2 0-2.4.1-3.5.4z"/>
                  <path fill="#0f4bb8" d="M12 39c.6 5.5 5.3 10 11 10h32c4.4 0 8-3.2 8-7.5 0-2.6-1.4-4.8-3.6-6.1-.8 7.1-7 12.6-14.3 12.6H22.5C16.9 48 12.3 44.2 12 39z"/>
                </svg>
                <span class="icon-label">OneDrive</span>
              </a>

              <a class="icon-btn" href="https://www.google.com/" target="_blank" rel="noopener noreferrer" title="Open Google">
                <span class="g-badge" aria-hidden="true">G</span>
                <span class="icon-label">Google</span>
              </a>
            </div>
          </div>

          <!-- Duty Search -->
          <div class="card" id="dutySearchCard">
            <h2>Duty Search <span class="icon-sub" id="dutyStatus">loading…</span></h2>
            <div class="hint">Type a duty number (loads from <code>duties.json</code> in this folder)</div>

            <div class="row two">
              <input id="dutySearchInput" placeholder="Search duty number (e.g. 2001 or 001)" inputmode="numeric" />
              <button id="dutyClearBtn" type="button">Clear</button>
            </div>

            <div id="dutyResults" style="margin-top:10px;"></div>
          </div>

          <!-- Motivation -->
          <div class="card">
            <h2>Motivation <span class="icon-sub" id="quoteCounter">—</span></h2>
            <div class="hint">Quick boost for the shift (saved)</div>

            <div class="quote-box">
              <p class="quote" id="quoteText">—</p>
              <p class="quote-by" id="quoteBy"></p>

              <div class="quote-actions">
                <button class="tiny-btn" id="newQuoteBtn" type="button">New quote</button>
                <label class="toggle">
                  <input type="checkbox" id="autoQuoteToggle" />
                  Auto change (30 min)
                </label>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Stena Buses</h2>
            <div class="hint">Up to 2 fleet numbers (saved automatically)</div>
            <div class="row two">
              <input id="stenaFleet1" placeholder="Fleet number 1 (e.g., 12345)" />
              <input id="stenaFleet2" placeholder="Fleet number 2 (e.g., 67890)" />
            </div>
          </div>

          <div class="card">
            <h2>Staff Bus</h2>
            <div class="hint">Up to 6 entries (Name + Time)</div>
            <div class="row" id="staffBusRows"></div>
            <div class="mini">Tip: times accept anything (e.g., 18:10 / 6.10pm / 1810).</div>
          </div>

          <div class="card">
            <h2>Notes</h2>
            <div class="hint">Keep track of what’s happened today etc (saved automatically)</div>
            <textarea id="notes" placeholder="Write notes here..."></textarea>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Duty Modal -->
  <div class="modal" id="dutyModal" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="dutyModalTitle">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="dutyModalTitle">Duty</div>
          <div class="modal-sub" id="dutyModalMeta"></div>
        </div>
        <div class="modal-actions">
          <button type="button" id="dutyCopyBtn">Copy</button>
          <button type="button" id="dutyCloseBtn" class="danger">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="duty-kv" id="dutyKV"></div>
        <div class="raw-toggle" id="rawToggle">Show raw</div>
        <div class="board-grid" id="boardGrid"></div>
        <pre class="duty-pre" id="dutyModalBody" style="display:none;"></pre>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // CHECKLIST ITEMS
    // ----------------------------
    const ITEMS = [
      { type: "header", title: "Start of shift", hint: "Traffic / AVL / adjustments" },
      { type: "task", id: "start-traffic-issues", name: "Deal with any traffic issues", desc: "" },
      { type: "task", id: "start-avl-late-running", name: "Use AVL to check late running", desc: "" },
      { type: "task", id: "start-driver-legality", name: "Check driver legality if running late", desc: "" },
      { type: "task", id: "start-adjust-break", name: "Adjust if need to come off for break", desc: "" },
      { type: "task", id: "start-adjust-mix-routes", name: "Be mindful when adjusting (mix routes)", desc: "Don’t have too many same routes in a row.\nThink where pax are and adjust at other end if needed." },
      { type: "task", id: "start-shunt-cars", name: "Bring in 2 shunt cars when not needed", desc: "Remember the defect cards." },

      { type: "header", title: "Next Day Set Up", hint: "Printing / spreadsheets / key list" },
      { type: "task", id: "nextday-shunt-defect-cards", name: "Shunt defect cards", desc: "4 cards / 2 on Sunday." },
      { type: "task", id: "nextday-traffic-output", name: "Print: Traffic Output Sheet", desc: "Reports." },
      { type: "task", id: "nextday-da", name: "Print: D&A", desc: "Other email." },
      { type: "task", id: "nextday-daily-check", name: "Print: Daily check sheet", desc: "Tray." },
      { type: "task", id: "nextday-random-check", name: "Print: Random Check Sheet", desc: "Tray." },
      { type: "task", id: "nextday-staff-bus-sheet", name: "Print: Staff Bus Sheet", desc: "" },
      { type: "task", id: "nextday-print-defect-cards", name: "Print defect cards", desc: "Mon–Fri (with Schools): 65\nMon–Fri (no schools): 65\nSat (no schools): 50\nSun: 25" },
      { type: "task", id: "nextday-print-rtw", name: "Print any outstanding RTW", desc: "" },
      { type: "task", id: "nextday-new-runout-spreadsheet", name: "Create new run out spreadsheet", desc: "OneDrive." },
      { type: "task", id: "nextday-fill-key-list", name: "Fill in Key list", desc: "Remember to change to next day on activity search in Grampian." },

      { type: "header", title: "Miscellaneous", hint: "CCTV / ODO / reports / scans" },
      { type: "task", id: "misc-cctv-intray", name: "Check CCTV in-tray, OPM60, print missed", desc: "" },
      { type: "task", id: "misc-cctv-save", name: "Save CCTV to external hard drive", desc: "" },
      { type: "task", id: "misc-odo-readings", name: "Record ODO readings", desc: "Enter figures onto spreadsheet + running board details for that bus.\nSunday only: choose 3 buses / take ODO readings and set up following week." },
      { type: "task", id: "misc-print-extra-work", name: "Print report: Extra Work", desc: "Change to today." },
      { type: "task", id: "misc-print-spares", name: "Print report: Spares Report", desc: "Change to today / change to spares / utilisation report." },
      { type: "task", id: "misc-print-variation", name: "Print report: Variation Report", desc: "Change to today–today." },
      { type: "task", id: "misc-scan-forward-reports", name: "Scan reports + forward email to Duty Managers", desc: "Include RTA from morning.\nChange settings to 2-sided." },
      { type: "task", id: "misc-yard-plan-route", name: "Yard Plan route", desc: "Always stick to the same route to ensure none are missed." },
      { type: "task", id: "misc-yard-plan-print", name: "Print 2 yard plans", desc: "1 for desk, 1 for banksman.\nIncrease one to 141% and put on wall." },
      { type: "task", id: "misc-yard-plan-forward-dave", name: "Forward yard plan to Dave Jones", desc: "" },
      { type: "task", id: "misc-handover-email", name: "Send handover email to morning desk man", desc: "" },

      { type: "header", title: "Other", hint: "Sunday-only + VOR + mileage + coverage" },
      { type: "task", id: "other-absence-report-sun", name: "Print absence report + check against Attendance cards", desc: "Sunday only." },
      { type: "task", id: "other-lost-property-sun", name: "Remove lost property over 2 weeks old", desc: "Sunday only." },
      { type: "task", id: "other-gained-mileage-stena", name: "Record gained mileage for Stena", desc: "" },
      { type: "task", id: "other-drop-mileage-avl", name: "If dropping mileage, do on AVL straight away", desc: "Ensure EPM is updated before you leave." },
      { type: "task", id: "other-returned-defect-cards", name: "Mark off returned defect cards", desc: "Check podium / cleaners / bus if any missing." },
      { type: "task", id: "other-missing-cards-email", name: "Report missing cards on email + mark as VOR on log", desc: "" },
      { type: "task", id: "other-vor-log-update", name: "Update VOR log", desc: "Record card if Eng have not looked at card then:\n• Pink – VOR/Card\n• Blue – Schools\n• Orange – Stena\n• Yellow – Torque/other" },
      { type: "task", id: "other-yard-plan-colours", name: "Put colours onto printed yard plan", desc: "" },
      { type: "task", id: "other-runout-spreadsheet-vor", name: "Add VOR / Schools etc onto run out spreadsheet/locations", desc: "" },
      { type: "task", id: "other-cover-week-work", name: "Work on covering work for the week ASAP", desc: "Remember you have limited time on lates." },
    ];

    // ----------------------------
    // STORAGE KEYS
    // ----------------------------
    const STORAGE_CHECKS = "lateShiftChecklistState.v1";
    const STORAGE_FORMS  = "lateShiftForms.v1";
    const STORAGE_QUOTES = "lateShiftQuoteState.v1";

    // ----------------------------
    // ELEMENTS
    // ----------------------------
    const taskListEl = document.getElementById("taskList");
    const progressTextEl = document.getElementById("progressText");
    const progressBarEl = document.getElementById("progressBar");
    const clearBtn = document.getElementById("clearBtn");
    const markAllBtn = document.getElementById("markAllBtn");

    const todayPill = document.getElementById("todayPill");
    const timePill = document.getElementById("timePill");
    const weatherPill = document.getElementById("weatherPill");

    const stenaFleet1 = document.getElementById("stenaFleet1");
    const stenaFleet2 = document.getElementById("stenaFleet2");
    const notesEl = document.getElementById("notes");
    const staffBusRows = document.getElementById("staffBusRows");

    const quoteTextEl = document.getElementById("quoteText");
    const quoteByEl = document.getElementById("quoteBy");
    const quoteCounterEl = document.getElementById("quoteCounter");
    const newQuoteBtn = document.getElementById("newQuoteBtn");
    const autoQuoteToggle = document.getElementById("autoQuoteToggle");

    // Duty search elements
    const dutyStatusEl = document.getElementById("dutyStatus");
    const dutyInputEl = document.getElementById("dutySearchInput");
    const dutyResultsEl = document.getElementById("dutyResults");
    const dutyClearBtn = document.getElementById("dutyClearBtn");

    const dutyModal = document.getElementById("dutyModal");
    const dutyCloseBtn = document.getElementById("dutyCloseBtn");
    const dutyCopyBtn = document.getElementById("dutyCopyBtn");
    const dutyModalTitle = document.getElementById("dutyModalTitle");
    const dutyModalMeta = document.getElementById("dutyModalMeta");
    const dutyModalBody = document.getElementById("dutyModalBody");
    const boardGrid = document.getElementById("boardGrid");
    const rawToggle = document.getElementById("rawToggle");
    const dutyKV = document.getElementById("dutyKV");

    // ----------------------------
    // DATE + CLOCK
    // ----------------------------
    function setTodayLabel() {
      const d = new Date();
      const formatted = d.toLocaleDateString(undefined, {
        weekday: "short", year: "numeric", month: "short", day: "numeric"
      });
      todayPill.querySelector("span:last-child").textContent = formatted;
    }

    function startClock() {
      const tick = () => {
        const now = new Date();
        const t = now.toLocaleTimeString(undefined, {
          hour: "2-digit", minute: "2-digit", second: "2-digit"
        });
        timePill.querySelector("span:last-child").textContent = t;
      };
      tick();
      setInterval(tick, 1000);
    }

    // ----------------------------
    // WEATHER (Birkenhead) refresh every 5 minutes
    // ----------------------------
    const FIXED_WEATHER_LOCATION = "Birkenhead, UK";
    const WEATHER_REFRESH_MS = 5 * 60 * 1000;

    function setWeatherText(text) {
      weatherPill.querySelector("span:last-child").textContent = text;
    }

    function weatherCodeToText(code) {
      const map = {
        0: "Clear", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
        45: "Fog", 48: "Rime fog",
        51: "Light drizzle", 53: "Drizzle", 55: "Heavy drizzle",
        56: "Freezing drizzle", 57: "Heavy freezing drizzle",
        61: "Light rain", 63: "Rain", 65: "Heavy rain",
        66: "Freezing rain", 67: "Heavy freezing rain",
        71: "Light snow", 73: "Snow", 75: "Heavy snow",
        77: "Snow grains",
        80: "Rain showers", 81: "Heavy showers", 82: "Violent showers",
        85: "Snow showers", 86: "Heavy snow showers",
        95: "Thunderstorm", 96: "Thunderstorm + hail", 99: "Thunderstorm + heavy hail",
      };
      return map[code] ?? `Weather ${code}`;
    }

    async function geocodePlace(place) {
      const url =
        `https://geocoding-api.open-meteo.com/v1/search` +
        `?name=${encodeURIComponent(place)}` +
        `&count=1&language=en&format=json`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Geocoding failed");
      const data = await res.json();
      const first = data?.results?.[0];
      if (!first) throw new Error("No geocoding results");
      return { lat: first.latitude, lon: first.longitude };
    }

    async function fetchWeather(lat, lon) {
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${encodeURIComponent(lat)}` +
        `&longitude=${encodeURIComponent(lon)}` +
        `&current=temperature_2m,weather_code,wind_speed_10m` +
        `&temperature_unit=celsius&wind_speed_unit=mph`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Weather fetch failed");
      return res.json();
    }

    let cachedCoords = null;

    async function updateWeatherOnce() {
      try {
        if (!cachedCoords) cachedCoords = await geocodePlace(FIXED_WEATHER_LOCATION);

        const data = await fetchWeather(cachedCoords.lat, cachedCoords.lon);
        const c = data?.current;
        if (!c) throw new Error("No current weather");

        const temp = Math.round(c.temperature_2m);
        const wind = Math.round(c.wind_speed_10m);
        const desc = weatherCodeToText(c.weather_code);

        setWeatherText(`Birkenhead • ${temp}°C • ${desc} • Wind ${wind}mph`);
      } catch {
        setWeatherText("Birkenhead • Weather unavailable");
      }
    }

    function initWeather() {
      setWeatherText("Birkenhead weather…");
      updateWeatherOnce();
      setInterval(updateWeatherOnce, WEATHER_REFRESH_MS);
    }

    // ----------------------------
    // CHECKLIST STORAGE
    // ----------------------------
    function loadChecks() {
      try {
        const raw = localStorage.getItem(STORAGE_CHECKS);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveChecks(state) {
      localStorage.setItem(STORAGE_CHECKS, JSON.stringify(state));
    }

    function taskItemsOnly() {
      return ITEMS.filter(i => i.type === "task");
    }

    // ----------------------------
    // FORMS STORAGE
    // ----------------------------
    function loadForms() {
      try {
        const raw = localStorage.getItem(STORAGE_FORMS);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveForms(next) {
      localStorage.setItem(STORAGE_FORMS, JSON.stringify(next));
    }

    function getFormState() {
      const state = loadForms();
      return {
        stenaFleet1: state.stenaFleet1 || "",
        stenaFleet2: state.stenaFleet2 || "",
        notes: state.notes || "",
        staffBus: Array.isArray(state.staffBus) ? state.staffBus : []
      };
    }

    function setFormState(partial) {
      const current = loadForms();
      const next = { ...current, ...partial };
      saveForms(next);
    }

    // Build staff bus rows (6 lines)
    function buildStaffBusRows() {
      staffBusRows.innerHTML = "";

      for (let i = 0; i < 6; i++) {
        const row = document.createElement("div");
        row.className = "row two";
        row.style.marginBottom = "8px";

        const name = document.createElement("input");
        name.placeholder = `Name ${i + 1}`;
        name.dataset.staffIndex = String(i);
        name.dataset.staffField = "name";

        const time = document.createElement("input");
        time.placeholder = `Time ${i + 1} (e.g., 18:10)`;
        time.dataset.staffIndex = String(i);
        time.dataset.staffField = "time";

        row.appendChild(name);
        row.appendChild(time);
        staffBusRows.appendChild(row);
      }
    }

    function hydrateForms() {
      const state = getFormState();

      stenaFleet1.value = state.stenaFleet1;
      stenaFleet2.value = state.stenaFleet2;
      notesEl.value = state.notes;

      const inputs = staffBusRows.querySelectorAll("input");
      inputs.forEach(inp => {
        const idx = Number(inp.dataset.staffIndex);
        const field = inp.dataset.staffField;
        const entry = state.staffBus[idx] || { name: "", time: "" };
        inp.value = entry[field] || "";
      });
    }

    function debounce(fn, ms=250) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    function wireFormSaving() {
      stenaFleet1.addEventListener("input", () => setFormState({ stenaFleet1: stenaFleet1.value }));
      stenaFleet2.addEventListener("input", () => setFormState({ stenaFleet2: stenaFleet2.value }));

      notesEl.addEventListener("input", debounce(() => {
        setFormState({ notes: notesEl.value });
      }, 250));

      staffBusRows.addEventListener("input", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement)) return;

        const idx = Number(target.dataset.staffIndex);
        const field = target.dataset.staffField;

        const state = getFormState();
        const staff = Array.from({ length: 6 }, (_, i) => state.staffBus[i] || { name: "", time: "" });

        staff[idx] = { ...staff[idx], [field]: target.value };
        setFormState({ staffBus: staff });
      });
    }

    // ----------------------------
    // QUOTES
    // ----------------------------
    const QUOTES = [
      { q: "Do the next right thing.", by: "Shift rule" },
      { q: "Slow is smooth. Smooth is fast.", by: "Operations mantra" },
      { q: "Control the controllables.", by: "Daily reminder" },
      { q: "Stay calm. Stay sharp.", by: "Late shift energy" },
      { q: "One task at a time — then the next.", by: "Checklist logic" },
      { q: "You don’t have to be perfect — just consistent.", by: "Consistency wins" },
      { q: "Small wins stack up.", by: "Keep moving" },
      { q: "Make it easy for the morning shift.", by: "Good handover" },
      { q: "If you’re not sure… ask.", by: "Always" }
    ];

    function loadQuoteState(){
      try{
        const raw = localStorage.getItem(STORAGE_QUOTES);
        return raw ? JSON.parse(raw) : { idx: 0, auto: false };
      }catch{
        return { idx: 0, auto: false };
      }
    }

    function saveQuoteState(state){
      localStorage.setItem(STORAGE_QUOTES, JSON.stringify(state));
    }

    function setQuote(idx){
      const q = QUOTES[idx % QUOTES.length];
      quoteTextEl.textContent = `“${q.q}”`;
      quoteByEl.textContent = q.by ? `— ${q.by}` : "";
      quoteCounterEl.textContent = `${(idx % QUOTES.length) + 1}/${QUOTES.length}`;

      const st = loadQuoteState();
      saveQuoteState({ ...st, idx: idx % QUOTES.length });
    }

    function nextQuote(){
      const st = loadQuoteState();
      setQuote((st.idx ?? 0) + 1);
    }

    let quoteTimer = null;
    const QUOTE_INTERVAL_MS = 30 * 60 * 1000;

    function setAutoQuotes(enabled){
      const st = loadQuoteState();
      saveQuoteState({ ...st, auto: enabled });

      if (quoteTimer) {
        clearInterval(quoteTimer);
        quoteTimer = null;
      }
      if (enabled) {
        quoteTimer = setInterval(nextQuote, QUOTE_INTERVAL_MS);
      }
    }

    function initQuotes(){
      const st = loadQuoteState();
      autoQuoteToggle.checked = !!st.auto;

      if (typeof st.idx !== "number") {
        const r = Math.floor(Math.random() * QUOTES.length);
        setQuote(r);
      } else {
        setQuote(st.idx);
      }

      newQuoteBtn.addEventListener("click", nextQuote);
      autoQuoteToggle.addEventListener("change", () => setAutoQuotes(autoQuoteToggle.checked));

      if (st.auto) setAutoQuotes(true);
    }

    // ----------------------------
    // RENDER CHECKLIST
    // ----------------------------
    function renderChecklist() {
      const state = loadChecks();
      taskListEl.innerHTML = "";

      ITEMS.forEach(item => {
        if (item.type === "header") {
          const h = document.createElement("div");
          h.className = "section";
          h.innerHTML = `<span>${item.title}</span><small>${item.hint || ""}</small>`;
          taskListEl.appendChild(h);
          return;
        }

        const isDone = !!state[item.id];

        const row = document.createElement("label");
        row.className = `task ${isDone ? "done" : ""}`;

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = isDone;
        cb.addEventListener("change", () => {
          const next = loadChecks();
          next[item.id] = cb.checked;
          saveChecks(next);
          row.classList.toggle("done", cb.checked);
          updateProgress();
        });

        const text = document.createElement("div");
        text.className = "text";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = item.name;

        const desc = document.createElement("p");
        desc.className = "desc";
        desc.textContent = item.desc || "";

        text.appendChild(name);
        if (item.desc) text.appendChild(desc);

        row.appendChild(cb);
        row.appendChild(text);

        taskListEl.appendChild(row);
      });

      updateProgress();
    }

    function updateProgress() {
      const state = loadChecks();
      const tasks = taskItemsOnly();
      const total = tasks.length;
      const done = tasks.reduce((acc, t) => acc + (state[t.id] ? 1 : 0), 0);
      const pct = total ? Math.round((done / total) * 100) : 0;

      progressTextEl.textContent = `${done}/${total} done`;
      progressBarEl.style.width = `${pct}%`;

      markAllBtn.textContent = (done === total && total > 0) ? "Unmark all" : "Mark all";
    }

    // ----------------------------
    // BUTTONS
    // ----------------------------
    clearBtn.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_CHECKS);
      localStorage.removeItem(STORAGE_FORMS);
      // Quotes kept by default
      renderChecklist();
      buildStaffBusRows();
      hydrateForms();
      dutyInputEl.value = "";
      renderDutyResults([]);
    });

    markAllBtn.addEventListener("click", () => {
      const state = loadChecks();
      const tasks = taskItemsOnly();
      const total = tasks.length;
      const done = tasks.reduce((acc, t) => acc + (state[t.id] ? 1 : 0), 0);
      const mark = !(done === total && total > 0);

      const next = {};
      tasks.forEach(t => next[t.id] = mark);
      saveChecks(next);
      renderChecklist();
    });

    // ============================
    // DUTY SEARCH
    // Supports multiple duties.json shapes + field names
    // ============================
    let DUTIES = [];
    let DUTY_INDEX = [];

    function normalizeDutyNumber(s){
      return String(s ?? "").trim().replace(/[^\d]/g, "");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Attempt to reconstruct timetable where PDF extraction splits times and destinations into separate columns.
    // Strategy:
    // 1) collect a block of time-only lines (HH:MM)
    // 2) collect destination lines that look like stops/locations (letters + not headers)
    // 3) if counts line up, zip them together
    function parseDutyBoard(raw){
      const text = String(raw || "");
      const lines = text.split(/\r?\n/);

      const segments = [];
      let current = null;

      const startSegment = (title, sub) => {
        current = { title: title || "Duty block", sub: sub || "", dests: [], times: [] };
        segments.push(current);
      };

      // Helper patterns
      const timeToken = /\b\d{2}:\d{2}\b/g;
      const dottedLine = /^(.+?)\s*\.{10,}\s*$/; // destination with dotted leaders

      // Build segments based on DEST:/SER:/BUS NO/MEAL BREAK boundaries
      for (let i=0;i<lines.length;i++){
        const rawLine = lines[i] || "";
        const line = rawLine.replace(/\s+/g," ").trim();
        if (!line) continue;

        // Segment starters
        if (/^DEST:/i.test(line)){
          const title = line.replace(/^DEST:\s*/i,"").trim();
          startSegment(`DEST: ${title}`, "");
          continue;
        }
        if (/^MEAL BREAK/i.test(line)){
          startSegment("MEAL BREAK", line.replace(/\s+/g," ").trim());
          continue;
        }
        if (/^BUS NO/i.test(line)){
          // keep BUS NO as sub in current or start a block
          if (!current) startSegment("BUS", "");
          current.sub = current.sub ? `${current.sub} • ${line}` : line;
          continue;
        }
        if (/^SER:/i.test(line)){
          if (!current) startSegment("SERVICE", "");
          current.sub = current.sub ? `${current.sub} • ${line}` : line;
          continue;
        }

        // Ensure at least one segment exists (first block)
        if (!current) startSegment("Block", "");

        // Collect times in any line
        const times = line.match(timeToken);
        if (times) times.forEach(t => current.times.push(t));

        // Collect dotted destinations
        const m = line.match(dottedLine);
        if (m){
          const dest = m[1].replace(/\s{2,}/g," ").trim();
          if (dest && /[A-Za-z]/.test(dest)) current.dests.push(dest);
        }
      }

      // Pair within each segment: zip dests with last N times
      const out = segments.map(seg => {
        const d = seg.dests;
        const t = seg.times;
        let pairs = [];
        if (d.length){
          const slice = t.length >= d.length ? t.slice(t.length - d.length) : t;
          const n = Math.min(d.length, slice.length);
          for (let i=0;i<n;i++){
            pairs.push({ destination: d[i], time: slice[i] });
          }
        }
        return { title: seg.title, sub: seg.sub, pairs, destCount: d.length, timeCount: t.length };
      });

      // Remove empty segments (no pairs and no useful sub)
      return out.filter(s => (s.pairs && s.pairs.length) || (s.sub && s.sub.length));
    }

    function toDutyRecord(d){
      // Normalize common field names from different extractors
      const dutyNum =
        d.duty_number ?? d.dutyNumber ?? d.duty ?? d.number ?? d.id ?? "";

      const rawText =
        d.raw_text ?? d.text ?? d.content ?? d.body ?? d.full_text ?? "";

      return {
        ...d,
        duty_number: String(dutyNum),
        raw_text: String(rawText || ""),
        day: d.day ?? d.dayType ?? d.day_type ?? "",
        depot: d.depot ?? "",
        commencing: d.commencing ?? d.start ?? d.start_time ?? "",
        sign_on: d.sign_on ?? d.signOn ?? d.signon ?? "",
        sign_off: d.sign_off ?? d.signOff ?? d.signoff ?? "",
        pay_time: d.pay_time ?? d.pay ?? "",
        meal_break: d.meal_break ?? d.meal ?? "",
        source_pdf: d.source_pdf ?? d.source ?? d.file ?? ""
      };
    }

    function kv(label, value){
      const el = document.createElement("div");
      el.className = "kv";
      el.innerHTML = `<strong>${label}:</strong> ${value || "—"}`;
      return el;
    }

    function openDutyModal(duty){
      if (!dutyModal || !dutyModalBody) return;

      dutyModal.classList.add("show");
      dutyModal.setAttribute("aria-hidden", "false");

      const num = duty?.duty_number || "—";
      dutyModalTitle.textContent = `Duty ${num}`;

      const meta = [];
      if (duty?.day) meta.push(duty.day);
      if (duty?.depot) meta.push(duty.depot);
      if (duty?.commencing) meta.push(`Commencing ${duty.commencing}`);
      if (duty?.source_pdf) meta.push(duty.source_pdf);
      dutyModalMeta.textContent = meta.join(" • ");

      dutyKV.innerHTML = "";
      const hasKV = !!(duty.sign_on || duty.sign_off || duty.pay_time || duty.meal_break);
      if (hasKV){
        dutyKV.appendChild(kv("Sign on", duty.sign_on));
        dutyKV.appendChild(kv("Sign off", duty.sign_off));
        dutyKV.appendChild(kv("Pay", duty.pay_time));
        dutyKV.appendChild(kv("Meal", duty.meal_break));
      }

      const raw = (duty?.raw_text || "").trim();
      dutyModalBody.textContent = raw || "No duty text available in duties.json for this duty.";

      // Render board view (destination + time rows, in blocks)
      boardGrid.innerHTML = "";
      const blocks = parseDutyBoard(raw);

      if (blocks.length){
        blocks.forEach(b => {
          const card = document.createElement("div");
          card.className = "board-card";

          const head = document.createElement("div");
          head.className = "board-head";
          head.innerHTML = `
            <div class="board-title">
              <span>${escapeHtml(b.title)}</span>
              <span class="icon-sub">${b.pairs.length || 0} rows</span>
            </div>
            <div class="board-sub">${escapeHtml(b.sub || `Dest ${b.destCount} • Times ${b.timeCount}`)}</div>
          `;

          const rows = document.createElement("div");
          rows.className = "board-rows";

          if (b.pairs && b.pairs.length){
            b.pairs.forEach(r => {
              const row = document.createElement("div");
              row.className = "board-row";
              row.innerHTML = `<div class="board-dest">${escapeHtml(r.destination)}</div><div class="board-time">${escapeHtml(r.time)}</div>`;
              rows.appendChild(row);
            });
          } else {
            const note = document.createElement("div");
            note.className = "board-note";
            note.textContent = "No destination/time rows detected in this block.";
            rows.appendChild(note);
          }

          card.appendChild(head);
          card.appendChild(rows);
          boardGrid.appendChild(card);
        });
      } else {
        boardGrid.innerHTML = `<div class="mini">Couldn’t build the board view for this duty — click “Show raw” to view the extracted text.</div>`;
      }

      dutyModalBody.style.display = "none";
      rawToggle.style.display = "inline";
      rawToggle.textContent = "Show raw";
    }

    function closeDutyModal(){
      if (!dutyModal) return;
      dutyModal.classList.remove("show");
      dutyModal.setAttribute("aria-hidden", "true");
    }

    dutyCloseBtn?.addEventListener("click", closeDutyModal);
    dutyModal?.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.dataset && t.dataset.close === "true") closeDutyModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && dutyModal?.classList.contains("show")) closeDutyModal();
    });


    // Raw toggle
    rawToggle?.addEventListener("click", () => {
      const showing = dutyModalBody.style.display !== "none";
      dutyModalBody.style.display = showing ? "none" : "block";
      rawToggle.textContent = showing ? "Show raw" : "Hide raw";
    });


    dutyCopyBtn?.addEventListener("click", async () => {
      try{
        const text = `${dutyModalTitle.textContent}\n${dutyModalMeta.textContent}\n\n${dutyModalBody.textContent}`;
        await navigator.clipboard.writeText(text);
        dutyCopyBtn.textContent = "Copied!";
        setTimeout(() => (dutyCopyBtn.textContent = "Copy"), 900);
      }catch{
        dutyCopyBtn.textContent = "Copy failed";
        setTimeout(() => (dutyCopyBtn.textContent = "Copy"), 900);
      }
    });

    dutyClearBtn?.addEventListener("click", () => {
      if (!dutyInputEl) return;
      dutyInputEl.value = "";
      renderDutyResults([]);
      dutyInputEl.focus();
    });

    function makePreview(duty){
      const t = (duty.raw_text || "").replace(/\s+/g, " ").trim();
      return t.slice(0, 140);
    }

    function renderDutyResults(matches){
      if (!dutyResultsEl) return;

      if (!matches.length){
        dutyResultsEl.innerHTML = `<div class="mini">Type a duty number above to search.</div>`;
        return;
      }

      dutyResultsEl.innerHTML = "";
      matches.slice(0, 20).forEach(d => {
        const row = document.createElement("div");
        row.className = "result";
        row.tabIndex = 0;
        row.setAttribute("role","button");
        row.setAttribute("aria-label", `Open duty ${d.duty_number}`);

        const left = document.createElement("div");
        left.className = "result-left";

        const subParts = [];
        if (d.day) subParts.push(d.day);
        if (d.depot) subParts.push(d.depot);
        if (d.sign_on && d.sign_off) subParts.push(`${d.sign_on}–${d.sign_off}`);
        const sub = subParts.join(" • ");
        const preview = makePreview(d);

        left.innerHTML = `
          <div class="result-title">Duty ${d.duty_number}</div>
          <div class="result-sub">${sub}${sub && preview ? " • " : ""}${preview}</div>
        `;

        const btn = document.createElement("button");
        btn.className = "result-btn";
        btn.type = "button";
        btn.textContent = "Open";
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          openDutyModal(d);
        });

        row.addEventListener("click", () => openDutyModal(d));
        row.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            openDutyModal(d);
          }
        });

        row.appendChild(left);
        row.appendChild(btn);
        dutyResultsEl.appendChild(row);
      });
    }

    function searchDuties(query){
      const q = normalizeDutyNumber(query);
      if (!q) return [];

      const starts = DUTY_INDEX.filter(x => x.norm.startsWith(q));
      const contains = DUTY_INDEX.filter(x => !x.norm.startsWith(q) && x.norm.includes(q));
      return [...starts, ...contains].slice(0, 60).map(x => DUTIES[x.i]);
    }

    function wireDutySearch(){
      if (!dutyInputEl) return;
      dutyInputEl.addEventListener("input", () => {
        const matches = searchDuties(dutyInputEl.value);
        renderDutyResults(matches);
      });
    }

    async function loadDutiesJSON(){
      try{
        dutyStatusEl.textContent = "loading…";
        const res = await fetch("duties.json", { cache: "no-store" });
        if (!res.ok) throw new Error("duties.json not found");

        const data = await res.json();

        const dutiesRaw =
          Array.isArray(data) ? data :
          Array.isArray(data?.duties) ? data.duties :
          Array.isArray(data?.items) ? data.items :
          [];

        DUTIES = dutiesRaw.map(toDutyRecord).filter(d => normalizeDutyNumber(d.duty_number).length > 0);

        DUTY_INDEX = DUTIES.map((d, i) => ({
          i,
          raw: d.duty_number,
          norm: normalizeDutyNumber(d.duty_number)
        }));

        dutyStatusEl.textContent = `${DUTIES.length} duties`;
        renderDutyResults([]);
        wireDutySearch();
      }catch(err){
        dutyStatusEl.textContent = "not loaded";
        if (dutyResultsEl){
          dutyResultsEl.innerHTML = `
            <div class="mini">
              <strong>Couldn’t load duties.json.</strong><br/>
              Ensure <code>index.html</code> and <code>duties.json</code> are in the same GitHub Pages folder.
            </div>
          `;
        }
      }
    }

    // ----------------------------
    // BOOT
    // ----------------------------
    setTodayLabel();
    startClock();
    initWeather();

    buildStaffBusRows();
    hydrateForms();
    wireFormSaving();

    initQuotes();
    renderChecklist();

    loadDutiesJSON();
  </script>
</body>
</html>
